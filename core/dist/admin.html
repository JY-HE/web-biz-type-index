<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1.0" />
        <link rel="stylesheet" href="./assets/index.css" />
        <link href="./assets/tailwind.min.css" rel="stylesheet" />
        <link href="./assets/style.css" rel="stylesheet" />
        <!-- <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/element-plus/dist/index.css" /> -->
        <script src="./assets/axios.min.js"></script>
        <script src="./assets/vue.global.prod.js"></script>
        <script src="./assets/index.full.min.js"></script>
        <title>web-biz-typeÊé•Âè£Á±ªÂûãÂÆö‰πâÁÆ°ÁêÜ</title>
    </head>
    <body>
        <div id="admin">
            <el-container style="height: 100vh">
                <el-header>
                    <div class="logo">Êé•Âè£Á±ªÂûãÂÆö‰πâÁÆ°ÁêÜ</div>
                    <div class="nav">
                        <div class="navItem" :class="{active: item.name === activeName}" v-for="item in menuItem" :key="item.name" @click="handleMenuClick(item)">{{item.label}}</div>
                    </div>
                </el-header>
                <el-main v-loading="loading">
                    <div class="addContainer" v-if="['add','manage'].includes(activeName)">
                        <div class="tableContainer" v-if="step === 0">
                            <div class="bizItem" v-for="(list, name) in newApi" :key="name">
                                <h4 class="bizName">{{name}}</h4>
                                <el-table :data="list" style="width: 100%">
                                    <el-table-column type="expand">
                                        <template v-slot="props">
                                            <el-row class="px-10 py-5">
                                                <el-col :span="12">
                                                    <el-descriptions title="ËØ∑Ê±ÇÂèÇÊï∞" :column="1">
                                                        <el-descriptions-item :label="key" v-for="(value, key) in getParams(props.row)">{{value || ''}}</el-descriptions-item>
                                                    </el-descriptions>
                                                </el-col>
                                                <el-col :span="12">
                                                    <el-descriptions title="ËØ∑Ê±ÇÁªìÊûú" :column="1">
                                                        <el-descriptions-item :label="key" v-for="(value, key) in getResponse(props.row)">{{value || ''}}</el-descriptions-item>
                                                    </el-descriptions>
                                                </el-col>
                                            </el-row>
                                        </template>
                                    </el-table-column>

                                    <el-table-column prop="summary" label="Êé•Âè£ÊèèËø∞"></el-table-column>
                                    <el-table-column prop="url" label="url" width="300"></el-table-column>
                                    <el-table-column prop="method" label="ËØ∑Ê±ÇÁ±ªÂûã" width="100">
                                        <template #default="scope">
                                            <el-tag size="small" :type="methodColorType[scope.row.method]" effect="dark">{{scope.row.method.toUpperCase()}}</el-tag>
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="tag" label="Ê†áÁ≠æ" width="160"></el-table-column>
                                    <el-table-column prop="version" label="version" width="100"> </el-table-column>
                                    <el-table-column prop="requestTypeName" label="ËØ∑Ê±ÇÂèÇÊï∞Á±ªÂûãÂÆö‰πâÂêçÁß∞" width="250">
                                        <template #default="scope">
                                            <el-input v-model.trim="scope.row.requestTypeName" placeholder="ËØ∑ËæìÂÖ•" :disabled="!scope.row.parameters && !scope.row.requestBody" />
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="responsesTypeName" label="ÂìçÂ∫îÂèÇÊï∞Á±ªÂûãÂÆö‰πâÂêçÁß∞" width="250">
                                        <template #default="scope">
                                            <el-input v-model.trim="scope.row.responsesTypeName" placeholder="ËØ∑ËæìÂÖ•" :disabled="!scope.row.responses" />
                                        </template>
                                    </el-table-column>
                                    <el-table-column prop="operationId" label="operationId" width="180">
                                        <template #default="scope">
                                            <el-button type="primary" size="small" v-if="scope.row.operationId" @click="getRecommendApiName(scope.row.operationId)">{{scope.row.operationId}}</el-button>
                                        </template>
                                    </el-table-column>
                                    <el-table-column label="Êìç‰Ωú" width="170">
                                        <template #default="scope">
                                            <el-button type="primary" size="small" @click="operation('ignore',name,scope.$index)">ÂøΩÁï•</el-button>
                                            <el-button type="danger" size="small" @click="operation('delete',name,scope.$index)">Âà†Èô§</el-button>
                                        </template>
                                    </el-table-column>
                                </el-table>
                            </div>
                        </div>
                        <div class="tableContainer" v-else-if="step === 1">
                            <!-- <el-input
						:value="changeLogData"
						autosize
						type="textarea"
					/> -->
                            <div class="dataItem">
                                <h4>‰øÆÊîπËÆ∞ÂΩï</h4>
                                <div class="btnList">
                                    <el-button @click="copyPlus(changeLogData)">Â§çÂà∂Êõ¥Êñ∞ÊñáÊ°£</el-button>
                                    <el-button @click="replyCopyData">ÈáçÁΩÆÊñáÊ°£</el-button>
                                </div>
                            </div>
                            <div class="dataItem" v-for="(value, key) in newApi" :key="key">
                                <h4>{{key}}</h4>
                                <div class="btnList">
                                    <el-button type="primary" @click="copyData('api', key)">Â§çÂà∂ÂÖ¨ÂÖ±TypeÂÜÖÂÆπ</el-button>
                                    <el-button type="primary" plain @click="copyData('biz', key)">Â§çÂà∂Êé•Âè£TypeÂÜÖÂÆπ</el-button>
                                </div>
                            </div>
                        </div>
                        <div class="operation">
                            <el-button type="default" size="large" @click="step -= 1" v-if="step > 0">‰∏ä‰∏ÄÊ≠•</el-button>
                            <el-button type="primary" size="large" @click="save">‰∏ã‰∏ÄÊ≠•</el-button>
                        </div>
                    </div>
                </el-main>
            </el-container>
        </div>

        <script>
            const App = {
                data() {
                    return {
                        activeName: 'add',
                        newApi: {},
                        loading: false,
                        expands: [],
                        warehouseApi: {},
                        changeLogData: '',
                        step: 0,
                        markdownData: {},
                    };
                },
                computed: {
                    menuItem() {
                        return [
                            { label: 'Êñ∞Â¢ûÊé•Âè£Á±ªÂûãÂÆö‰πâ', name: 'add' },
                            { label: 'ÂÆåÂñÑÊé•Âè£Á±ªÂûãÂÆö‰πâ', name: 'manage' },
                            { label: 'Êü•ÁúãÊóßÊé•Âè£Á±ªÂûãÂÆö‰πâ', name: 'preview' },
                            { label: 'ÊñáÊ°£Êõ¥Êñ∞', name: 'updateDoc' },
                        ];
                    },
                    // ËØ∑Ê±ÇÁ±ªÂûãÊºîÁ§∫Êò†Â∞Ñ
                    methodColorType: () => ({ get: 'info', post: 'success', put: 'warning', delete: 'danger' }),
                    // ËØ∑Ê±ÇÂíåÂìçÂ∫îÂèÇÊï∞Á±ªÂûãÂÆö‰πâÂêçÁß∞ÈõÜÂêà
                    warehouseApiTypeNames() {
                        return Object.values(this.warehouseApi)
                            .filter((item) => item.length)
                            .reduce((pre, list) => {
                                return [...pre, ...list.map((i) => i.requestTypeName), ...list.map((i) => i.responsesTypeName)].filter(Boolean);
                            }, []);
                    },
                },
                methods: {
                    handleMenuClick({ name }) {
                        ['add', 'manage', 'preview'].includes(name) && (this.activeName = name);
                        name === 'add' && this.getNew();
                        name === 'manage' && this.getOld();
                        name === 'preview' && this.updateOld();
                        name === 'updateDoc' && this.updateDoc();
                    },
                    /** Ëé∑ÂèñÂ∑≤ÊúâÊé•Âè£ */
                    updateOld() {
                        this.loading = true;
                        fetch('/api/oldApi')
                            .then((res) => res.json())
                            .then((res) => {
                                this.newApi = res.data || {};
                            })
                            .finally(() => {
                                this.loading = false;
                            });
                    },
                    /** Ëé∑Âèñ‰ªìÂ∫ì‰∏¥Êó∂Êé•Âè£ */
                    getOld() {
                        this.loading = true;
                        fetch('/api/currentApi')
                            .then((res) => res.json())
                            .then((res) => {
                                this.newApi = res.data || {};
                            })
                            .finally(() => {
                                this.loading = false;
                            });
                    },
                    /** Ëé∑Âèñ‰ªìÂ∫ìÊé•Âè£ */
                    getNew() {
                        this.loading = true;
                        fetch('/api/newApi')
                            .then((res) => res.json())
                            .then((res) => {
                                this.newApi = res.data || {};
                            })
                            .finally(() => {
                                this.loading = false;
                            });
                        // ËØ∑Ê±ÇÂ∑≤ÊúâÊñπÊ≥ïÁºìÂ≠ò
                        fetch('/api/warehouse')
                            .then((res) => res.json())
                            .then((res) => {
                                this.warehouseApi = Object.entries(res.data || {}).reduce((obj, [k, v]) => ({ ...obj, [k]: Object.values(v) }), {});
                            });
                    },
                    // ÂèÇÊï∞Ê†ºÂºèÂåñ
                    getParams(data) {
                        const formatParamsData = data.method === 'get' ? data.parameters || [] : [].concat(data.parameters || [], data.requestBody || []) || [];
                        return formatParamsData.reduce((obj, i) => {
                            let str = `ÂèÇÊï∞Á±ªÂûãÔºö${i?.in === 'header' ? 'headers' : i.type} ÂèÇÊï∞ËØ¥ÊòéÔºö${i?.description || 'Á©∫'} ${i?.default ? ' ÈªòËÆ§ÂÄºÔºö' + i?.default : ''} ${i?.required ? 'ÔºàÂøÖÂ°´Ôºâ' : ''}`;
                            return { ...obj, [i.key]: str };
                        }, {});
                    },
                    // ÂìçÂ∫îÊ†ºÂºèÂåñ
                    getResponse(data) {
                        if (!data.responses) return {};
                        return data.responses.reduce((pre, i) => ({ ...pre, [i.key]: i.description }), {});
                    },
                    // ÈÖçÁΩÆ‰øùÂ≠ò
                    async save() {
                        await this.checkName();
                        if (this.step === 0) {
                            if (this.activeName === 'manage') {
                                this.step += 1;
                                return;
                            }
                            // Ê†°È™åÊòØÂê¶Â≠òÂú®Êú™Â°´ÂÜôÁ±ªÂûãÂÆö‰πâÂêçÁß∞ÁöÑÊï∞ÊçÆ
                            const errorData = Object.entries(this.newApi).reduce((obj, [bizName, list]) => {
                                if (obj) return obj;
                                const errorItem = list.find((item) => {
                                    // Êú™Â°´ÂÜôËØ∑Ê±ÇÁ±ªÂûãÂÆö‰πâÂêçÁß∞
                                    if (item.parameters || item.requestBody) {
                                        return item.requestTypeName === '';
                                    }
                                    // Êú™Â°´ÂÜôÂìçÂ∫îÁ±ªÂûãÂÆö‰πâÂêçÁß∞
                                    if (item.responses) {
                                        return item.responsesTypeName === '';
                                    }
                                });
                                return errorItem ? { ...errorItem, bizName } : null;
                            }, null);
                            if (errorData) {
                                console.log('üöÄ ~ admin.html:227 ~ errorData:', errorData);
                                if (!errorData.requestTypeName) {
                                    if (errorData.parameters || errorData.requestBody) {
                                        this.$message.warning(`ü§ñ${errorData.bizName} Êé•Âè£ ${errorData.summary} Êú™Â°´ÂÜôËØ∑Ê±ÇÁ±ªÂûãÂÆö‰πâÂêçÁß∞`);
                                        this.copy(errorData.summary);
                                    }
                                } else if (!errorData.responsesTypeName) {
                                    if (errorData.responses) {
                                        this.$message.warning(`ü§ñ${errorData.bizName} Êé•Âè£ ${errorData.summary} Êú™Â°´ÂÜôÂìçÂ∫îÁ±ªÂûãÂÆö‰πâÂêçÁß∞`);
                                        this.copy(errorData.summary);
                                    }
                                }
                                return;
                            }
                            const params = Object.entries(this.newApi).reduce((obj, [bizName, list]) => {
                                return { ...obj, [bizName]: list.map((i) => ({ url: i.url, methodName: i.methodName, method: i.method })) };
                            }, {});
                            const loading = this.$loading({
                                lock: true,
                                text: 'Ê≠£Âú®‰øùÂ≠òÈÖçÁΩÆ...',
                                spinner: 'el-icon-loading',
                                background: 'rgba(0, 0, 0, 0.5)',
                            });
                            axios
                                .post('/api/newApi', this.newApi)
                                .then((res) => {
                                    this.changeLogData = res.data.data;
                                    this.step += 1;
                                })
                                .finally(() => {
                                    loading.close();
                                });
                        } else {
                            this.updateDoc();
                        }
                    },
                    // Ê£ÄÊü•ÊòØÂê¶ÊúâÈáçÂêç
                    checkName() {
                        return new Promise((resolved, rejected) => {
                            const newApiNameArr = Object.entries(this.newApi).reduce((pre, [bizName, list]) => {
                                return [...pre, ...list.map((i) => i.requestTypeName), ...list.map((i) => i.responsesTypeName)].filter(Boolean);
                            }, []);
                            // Âà§Êñ≠newApiNameArrÊòØÂê¶ÊúâÈáçÂ§çÈ°π
                            const { duplicates } = newApiNameArr.reduce(
                                (acc, item) => {
                                    if (acc.seen.has(item)) {
                                        acc.duplicates.add(item);
                                    } else {
                                        acc.seen.add(item);
                                    }
                                    return acc;
                                },
                                { seen: new Set(), duplicates: new Set() }
                            );
                            if (duplicates.size) {
                                const duplicateArray = [...duplicates];
                                this.$message.error(`ü§ñ ${duplicateArray[0]} ÂêçÁß∞ÈáçÂ§ç`);
                                this.copy(duplicateArray[0]);
                                rejected();
                            }
                            // Âà§Êñ≠newApiNameArrÂíåwarehouseApiÊØîËæÉÊòØÂê¶ÊúâÈáçÂ§çÈ°π
                            const warehouseApiTypeNamesSet = new Set(this.warehouseApiTypeNames);
                            const equalArr = newApiNameArr.filter((item) => warehouseApiTypeNamesSet.has(item));
                            if (equalArr.length) {
                                this.$message.error(`ü§ñ ${equalArr[0]} ÂêçÁß∞‰∏éÂ∑≤ÊúâÊé•Âè£Á±ªÂûãÂÆö‰πâÂêçÁß∞ÈáçÂ§ç`);
                                this.copy(equalArr[0]);
                                rejected();
                            }
                            resolved();
                        });
                    },
                    // Êõ¥Êñ∞ÊñáÊ°£
                    updateDoc() {
                        // Êèê‰∫§Âà∞Á∫ø‰∏ä
                        this.$prompt('ËØ∑ËæìÂÖ•ÁâàÊú¨Âè∑', 'ÊèêÁ§∫', {
                            confirmButtonText: 'Á°ÆÂÆö',
                            cancelButtonText: 'ÂèñÊ∂à',
                            inputType: 'text',
                            inputPattern: /\S+/,
                            inputErrorMessage: 'ÁâàÊú¨Âè∑‰∏çËÉΩ‰∏∫Á©∫',
                        })
                            .then(({ value }) => {
                                axios.post('/api/updateDoc', { version: value }).then((res) => {
                                    if (res.data.status === 200) {
                                        this.$message.success('‰øùÂ≠òÊàêÂäü');
                                    } else {
                                        this.$message.error('‰øùÂ≠òÂ§±Ë¥•');
                                    }
                                });
                            })
                            .catch(() => {
                                this.$message.info('ÂèñÊ∂àÊõ¥Êñ∞');
                            });
                    },
                    // Â§çÂà∂markdownÂÜÖÂÆπ
                    async copyData(copyType, bizName) {
                        const strData = this.markdownData[bizName];
                        if (!strData) {
                            const res = await axios.get('/api/getMarkdown', { params: { bizName } });
                            if (res.data.data) {
                                const [api, biz] = res.data.data.split('\n----\n');
                                this.markdownData = { ...this.markdownData, [bizName]: { api, biz } };
                                this.copyPlus(this.markdownData[bizName][copyType]);
                            }
                        } else {
                            this.copyPlus(this.markdownData[bizName][copyType]);
                        }
                    },
                    replyCopyData() {
                        this.copyData = {};
                        this.$message.success('Ê∏ÖÈô§ÊàêÂäü');
                    },
                    // Êé•Âè£Êìç‰Ωú
                    async operation(scene, name, index) {
                        // Â∞ÜÊ≠§Êé•Âè£Ê∞∏‰πÖÂøΩÁï•
                        if (scene === 'ignore') {
                            const data = this.newApi[name][index];
                            const res = await axios.post('/api/ignore', {
                                bizName: name,
                                apiUrl: data.url,
                            });
                            if ([200, 403].includes(res.data.status)) {
                                this.newApi = {
                                    ...this.newApi,
                                    [name]: this.newApi[name].filter((_, i) => index !== i),
                                };
                                this.$message.success('Ê∑ªÂä†ÊàêÂäü');
                            }
                        }
                        // Ê≠§Ê¨°ÁºñËæëÂøΩÁï•Ê≠§Êé•Âè£
                        if (scene === 'delete') {
                            this.newApi = {
                                ...this.newApi,
                                [name]: this.newApi[name].filter((_, i) => index !== i),
                            };
                        }
                    },
                    // Â∞ÜÊé®ËçêÊñπÊ≥ïÂêçÊîæÂà∞Ââ™ÂàáÊùø
                    getRecommendApiName(name) {
                        const apiName = name.replace(/^[A-Z]/, (s) => s.toLowerCase());
                        this.copy(apiName);
                        this.$message.success('Â§çÂà∂ÊàêÂäü');
                    },
                    // Ê∑ªÂä†ÂÜÖÂÆπÂà∞Ââ™ÂàáÊùø
                    copy(str = '') {
                        if (!str) return;
                        const input = document.createElement('input');
                        input.value = str;
                        document.body.appendChild(input);
                        input.select();
                        document.execCommand('copy');
                        document.body.removeChild(input);
                    },
                    // ‰øùÁïôÊç¢Ë°åÁ¨¶Â§çÂà∂Âà∞Ââ™ÂàáÊùø
                    copyPlus(str = '') {
                        let that = this;
                        let txa = document.createElement('textarea');
                        txa.value = str;
                        document.body.appendChild(txa);
                        txa.select();
                        let res = document.execCommand('copy');
                        document.body.removeChild(txa);
                        this.$message.success('Â§çÂà∂ÊàêÂäü');
                    },
                },
            };
            Vue.createApp(App).use(ElementPlus).mount('#admin');
        </script>
    </body>
</html>
